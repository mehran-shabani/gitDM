name: Test Codespaces Setup

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  test-setup:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v5

    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: '3.12'
        cache: 'pip'

    - name: Prepare env file
      run: |
        if [ -f .env.example ]; then
          cp .env.example .env
        else
          printf "DJANGO_DEBUG=True\nDJANGO_SECRET_KEY=dev\n" > .env
        fi
      working-directory: ./backend

    - name: Install dependencies
      working-directory: ./backend
      run: |
        python -m pip install --upgrade pip
        pip install -r ../requirements.txt
        pip install -r requirements.txt
        pip install pytest pytest-django pytest-cov
        # Sanity check celery import for tasks decorated in apps
        python - <<'PY'
import importlib, sys
importlib.import_module('celery')
print('celery OK')
PY

    - name: Run migrations
      env:
        CODESPACES: true
      run: |
        python manage.py migrate
      working-directory: ./backend

    - name: Run tests
      env:
        CODESPACES: true
        DJANGO_SETTINGS_MODULE: config.settings
      run: |
        # Run tests with proper error handling
        pytest -v --tb=short
        
        # Run specific test to verify setup
        pytest tests/test_codespaces_setup.py -v || true
      working-directory: ./backend

    - name: Check Django settings (development mode)
      env:
        CODESPACES: true
      run: |
        python manage.py check
      working-directory: ./backend