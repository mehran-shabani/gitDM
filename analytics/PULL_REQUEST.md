# Pull Request: داشبورد تحلیلی پیشرفته

## خلاصه تغییرات

این PR یک داشبورد تحلیلی پیشرفته برای سیستم GitDM اضافه می‌کند که شامل موارد زیر است:

### ✨ ویژگی‌های جدید

1. **مدل‌های آنالیتیکس**
   - `PatientAnalytics`: ذخیره آمارهای تحلیلی بیماران
   - `DoctorAnalytics`: ذخیره آمارهای عملکرد پزشکان
   - `SystemAnalytics`: ذخیره آمارهای کلی سیستم
   - `Report`: مدیریت گزارش‌های تولید شده

2. **API Endpoints**
   - آنالیتیکس بیماران با نمودارهای قند خون و HbA1c
   - آنالیتیکس پزشکان با توزیع بیماران
   - آنالیتیکس سیستم با نمای کلی و روندها
   - سیستم گزارش‌گیری با قابلیت دانلود و ارسال ایمیل

3. **نمودارهای تعاملی**
   - نمودار روند قند خون (FBS, RBS, PPBS)
   - نمودار روند HbA1c با خط هدف درمانی
   - نمودار دایره‌ای توزیع بیماران
   - نمودارهای روند سیستمی

4. **گزارش‌گیری خودکار**
   - تولید گزارش PDF با پشتیبانی فارسی
   - خروجی Excel با چند برگه
   - گزارش‌های زمان‌بندی شده (Celery)
   - ارسال خودکار از طریق ایمیل

5. **داشبورد تعاملی**
   - کارت‌های آماری با انیمیشن
   - جداول بیماران نیازمند توجه
   - لیست هشدارهای اخیر
   - فیلترهای زمانی (هفته/ماه/فصل)

## 📋 چک‌لیست

- [x] طرح مسئله و تحلیل نیازمندی‌ها
- [x] طراحی معماری و مدل‌های داده
- [x] پیاده‌سازی سرویس‌های تحلیل داده
- [x] ایجاد API endpoints
- [x] پیاده‌سازی رابط کاربری با نمودارهای تعاملی
- [x] سیستم گزارش‌گیری PDF/Excel
- [x] Celery tasks برای پردازش‌های زمان‌بندی شده
- [x] تست‌های واحد
- [x] مستندسازی کامل

## 🔧 تغییرات فنی

### فایل‌های جدید
```
analytics/
├── __init__.py
├── admin.py
├── apps.py
├── models.py (4 مدل جدید)
├── serializers.py (10 سریالایزر)
├── views.py (5 ViewSet)
├── services.py (3 سرویس اصلی)
├── report_service.py (سرویس گزارش‌گیری)
├── tasks.py (6 Celery task)
├── tests.py (تست‌های جامع)
├── urls.py
├── README.md
├── templates/analytics/dashboard.html
├── static/analytics/
│   ├── css/dashboard.css
│   └── js/dashboard.js
└── migrations/
```

### تغییرات در فایل‌های موجود
- `config/settings.py`: اضافه کردن `analytics` به `INSTALLED_APPS`
- `gateway/urls.py`: اضافه کردن مسیر `analytics/`
- `requirements.txt`: اضافه کردن وابستگی‌های جدید

### وابستگی‌های جدید
```
numpy>=1.24.0        # محاسبات آماری
pandas>=2.0.0        # تحلیل داده
matplotlib>=3.7.0    # تولید نمودار
seaborn>=0.12.0      # نمودارهای پیشرفته
reportlab>=4.0.0     # تولید PDF
openpyxl>=3.1.0      # تولید Excel
```

## 🧪 تست‌ها

### تست‌های واحد
- تست محاسبه آنالیتیکس بیماران
- تست محاسبه روند قند خون
- تست امتیاز پایبندی به درمان
- تست آنالیتیکس پزشکان
- تست آنالیتیکس سیستم
- تست API endpoints
- تست دسترسی‌های امنیتی

### نحوه اجرای تست‌ها
```bash
python manage.py test analytics
```

## 🚀 نحوه استفاده

1. **نصب وابستگی‌ها**
   ```bash
   pip install -r requirements.txt
   ```

2. **اجرای میگریشن‌ها**
   ```bash
   python manage.py makemigrations analytics
   python manage.py migrate
   ```

3. **جمع‌آوری فایل‌های استاتیک**
   ```bash
   python manage.py collectstatic
   ```

4. **دسترسی به داشبورد**
   ```
   http://localhost:8000/analytics/dashboard/
   ```

## 📊 نمونه خروجی‌ها

### داشبورد
- نمایش آمار کلی (تعداد بیماران، ویزیت‌های امروز، هشدارهای فعال)
- نمودارهای تعاملی با قابلیت zoom و فیلتر
- جداول مرتب‌سازی شده

### گزارش PDF
- صفحه عنوان با اطلاعات بیمار/پزشک
- جداول آماری با قالب‌بندی زیبا
- نمودارها و چارت‌ها
- خلاصه و توصیه‌ها

### گزارش Excel
- برگه‌های جداگانه برای هر بخش
- قالب‌بندی شرطی
- فرمول‌های محاسباتی

## 🔒 ملاحظات امنیتی

- همه endpoints نیاز به احراز هویت دارند
- پزشکان فقط به داده‌های بیماران خود دسترسی دارند
- گزارش‌ها محدود به درخواست‌دهنده هستند
- لاگ‌گیری همه عملیات حساس

## 📈 Performance

- استفاده از `select_related` و `prefetch_related` برای بهینه‌سازی
- کش کردن داده‌های پرتکرار (5 دقیقه)
- محاسبات سنگین در background با Celery
- ایندکس‌گذاری مناسب روی فیلدهای پرکاربرد

## 🔄 Backward Compatibility

این PR هیچ breaking change ندارد و کاملاً با ساختار موجود سازگار است.

## 📝 مستندات

- README.md جامع در پوشه analytics
- Docstring برای همه کلاس‌ها و متدها
- کامنت‌های inline برای منطق پیچیده
- نمونه استفاده برای هر API endpoint

## ⚠️ نکات مهم

1. برای استفاده از گزارش‌های زمان‌بندی شده، Celery باید راه‌اندازی شود
2. برای PDF فارسی، فونت IRANSans.ttf باید در `static/fonts/` قرار گیرد
3. matplotlib از backend غیرتعاملی استفاده می‌کند (Agg)

## 🎯 Next Steps

پیشنهادات برای توسعه‌های آینده:
1. اضافه کردن Machine Learning برای پیش‌بینی روند
2. WebSocket برای بروزرسانی real-time
3. Export به فرمت‌های بیشتر (Word, PowerPoint)
4. نمودارهای پیشرفته‌تر (heatmap, scatter plot)

---

**نویسنده**: AI Assistant
**تاریخ**: {{ current_date }}
**نسخه**: 1.0.0