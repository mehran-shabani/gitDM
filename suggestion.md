# سناریوی کامل اپ (GitDM – سامانه مدیریت دیابت)

GitDM یک سامانهٔ مدیریت پرونده بیماران دیابتی مبتنی بر Django و DRF است که اهداف اصلی زیر را دنبال می‌کند:

- مدیریت چرخهٔ کامل دادهٔ بیمار: ساخت و نگهداری پروفایل بیمار (`gitdm.PatientProfile`) با مالکیت دکتر اصلی (`primary_doctor`).
- ثبت رویدادهای بالینی: مواجهه‌ها (`encounters`)، نتایج آزمایشگاهی (`laboratory`)، و دستورات دارویی (`pharmacy`).
- هوشمندسازی محتوا: تولید و نگهداری خلاصه‌های AI (`intelligence.AISummary`) از داده‌های بالینی و لینک‌سازی مراجع بالینی (`references`).
- نسخه‌بندی و بازگردانی: ثبت نسخه‌های تغییرات رکوردها و امکان بازگردانی به نسخه‌های قبلی (`versioning`).
- خروجی‌گیری متمرکز: ارائهٔ خروجی ساختاریافته از داده‌های بیمار از طریق endpoint اختصاصی Export.

جریان اصلی استفاده:
1) پزشک احراز هویت می‌شود (JWT). 2) بیمار جدید می‌سازد یا روی بیمار موجود کار می‌کند. 3) مواجهه/نتایج آزمایش/نسخهٔ دارویی ثبت می‌شود. 4) سامانه به‌صورت خودکار نسخه‌ها را ذخیره می‌کند و خلاصه‌های AI (ساده/سینک یا با Celery) را ایجاد می‌کند. 5) پزشک تایم‌لاین تجمیع‌شدهٔ بیمار را می‌بیند. 6) در صورت نیاز دادهٔ بیمار خروجی‌گیری می‌شود.


## ارزیابی پوشش سرور نسبت به انتظارات (با توجه به کد موجود)

- احراز هویت و مسیرها:
  - JWT در `config/urls.py` و `gateway/urls.py` در دسترس است؛ `CustomTokenObtainPairView` استفاده می‌شود.
  - مستندات OpenAPI/Swagger/Redoc طبق `config/urls.py` پیکربندی شده است.
  - health endpoint وجود دارد و تست‌های مربوطه پوشش می‌دهد.

- دامنهٔ بیمار (`gitdm`):
  - `PatientViewSet` با `IsAuthenticated` محافظت شده و `get_queryset` دسترسی را به بیمارانِ دکتر جاری محدود می‌کند؛ در `perform_create` دکتر جاری به‌عنوان `primary_doctor` ست می‌شود. این با انتظار امنیتی و دامنه‌گذاری داده هم‌خوان است.
  - اکشن `timeline` دادهٔ تجمیع‌شدهٔ encounters/labs/medications/ai_summaries را با سقف‌های منطقی برمی‌گرداند. با README و OpenAPI هم‌راستاست.

- مواجهه/آزمایش/دارو:
  - ViewSetهای پایه برای CRUD پیاده‌سازی شده‌اند. برای `encounters` `perform_create` `created_by` را ست می‌کند. مجوز پیش‌فرض پروژه `IsAuthenticated` است، اما فیلتر دامنه‌ای در لیست‌گیری برای این سه ماژول هنوز به صراحت اعمال نشده است (پیشنهاد در بخش پایین).

- هوش‌مصنوعی (`intelligence`):
  - `AISummaryViewSet` با `IsAuthenticated` و مسیرهای `list/retrieve/create/destroy` و اکشن‌های `regenerate/test/stats/test-references` موجود است. سرویس `OpenAIService` هم از GapGPT و هم OpenAI پشتیبانی دارد و در نبود کلیدها «fallback» ایمن دارد. وظایف Celery برای ساخت/بازتولید خلاصه‌ها تعریف شده‌اند (در حالت Codespaces Celery غیرفعال است اما مسیرها degrade امن دارند).

- نسخه‌بندی (`versioning`):
  - مدل `RecordVersion`، سرویس‌های `save_with_version` و `revert_to_version` و سیگنال‌های `post_save` برای `PatientProfile`, `Encounter`, `LabResult`, `MedicationOrder` پیاده شده‌اند. Diff محاسبه می‌شود، یکتا بودن نسخه‌ها تضمین شده و revert اتمیک است. Endpointهای `GET /api/versions/<type>/<id>/` و `POST /api/versions/<type>/<id>/revert/` وجود دارد. نکته: این دو endpoint فعلاً با `AllowAny` مارک شده‌اند که در محیط واقعی باید محدود شوند.

- Export:
  - `GET /api/export/patient/{id}/` موجود است اما با `@login_required` (مکانیزم Session) محافظت شده است و خروجی فعلاً شکل پایه دارد. با توجه به بقیهٔ API که JWT است، هم‌ترازسازی پیشنهاد می‌شود.

نتیجهٔ ارزیابی: هستهٔ مورد انتظار (مدل‌ها، ViewSetها، احراز هویت JWT، تایم‌لاین، AI Summaries با fallback، نسخه‌بندی با سیگنال‌ها و revert) حاضر است و کارِ لازم را در سطح MVP انجام می‌دهد. چند نکتهٔ امنیتی/هماهنگی و بهبود تجربه استفاده باقی است (پایین).


## پیشنهادهای انجام‌شده (Security/Consistency/UX)

1) هم‌ترازسازی محافظت Export با JWT و تکمیل داده‌ها:
   - اکنون `export_patient` با DRF (`IsAuthenticated`) محافظت می‌شود و بررسی مالکیت انجام می‌دهد؛ فقط دکترِ `primary_doctor` یا سوپر‌یوزر به خروجی دسترسی دارند. خروجی شامل encounters/labs/medications/ai_summaries به‌صورت ساختاریافته است.

2) محدودسازی دامنهٔ QuerySet در ViewSetهای `encounters`, `laboratory`, `pharmacy` و کنترل ایجاد:
   - لیست‌گیری این منابع به بیمارانی که `primary_doctor == request.user` دارند محدود شد؛ در `perform_create` نیز در صورت عدم مالکیت، خطای مجوز بازگردانده می‌شود.

3) ایمن‌سازی endpointهای نسخه‌بندی:
   - هر دو endpoint `versions` اکنون `IsAuthenticated` هستند و برای نوع `Patient` مالکیت بررسی می‌شود؛ فقط صاحب بیمار یا سوپر‌یوزر قادر به مشاهده/بازگردانی است.

4) هم‌نام‌سازی `resource_type` و رفع ارجاع تعریف‌نشده:
   - `RESOURCE_TYPE_ALIASES` تعریف شد تا نام کلاس‌ها به برچسب‌های نسخه‌بندی نرمالیزه شود (مانند نگاشت `PatientProfile` به `Patient`).

5) امنیت و ممیزی:
   - `security.middleware.AuditMiddleware` در `MIDDLEWARE` فعال شد تا ثبت رویدادهای درخواست انجام شود (بدون ایجاد اختلال در پاسخ).


## پیشنهاد ویژگی جدید 1: «هشدارهای بالینی مبتنی بر AI» (در مسیر بعدی)

- سناریو (دو خط): هنگام ثبت آزمایش HbA1c یا مواجهه با تشخیص جدید، سامانه به‌صورت خودکار خلاصهٔ AI را ارزیابی می‌کند و اگر معیارهای خطر (مثلاً HbA1c > 8.5%) برقرار باشد، یک هشدار ساختاریافته برای پزشک در تایم‌لاین بیمار نمایش می‌دهد.
- اجرا: مدل سادهٔ `ClinicalAlert` با فیلدهای `patient`, `severity`, `message`, `source_type` و یک سیگنال یا تسک Celery که پس از ایجاد Lab/Encounter ارزیابی کند. Endpoint `GET /alerts/?patient_id=...` و نمایش در پاسخ `timeline`.


## پیشنهاد ویژگی جدید 2: «Export امن و قابل سفارشی‌سازی» (در مسیر بعدی)

- سناریو (دو خط): پزشک می‌تواند برای مقاصد ارجاع یا انتقال، یک خروجی JSON/CSV شامل محدودهٔ زمانی مشخص و مجموعهٔ انتخابی از داده‌ها تولید کند؛ فایل خروجی با امضای دیجیتال یا هش جهت یکپارچگی برچسب‌گذاری می‌شود.
- اجرا: پارامترهای `fields[]`, `from`, `to`, `format` برای Export، اعمال permission و rate limit، و افزودن metadata شامل `generated_at`, `requested_by`, `checksum`.


## جمع‌بندی کوتاه

- اقدامات امنیتی و سازگاری کلیدی اعمال شد: JWT برای Export با کنترل مالکیت، محدودسازی دامنهٔ QuerySet و کنترل ایجاد، ایمن‌سازی نسخه‌بندی، تعریف alias نسخه‌ها، و فعال‌سازی ممیزی.
- دو ویژگی پیشنهادی می‌توانند در فاز بعدی ارزش بالینی و عملیاتی سیستم را افزایش دهند.

