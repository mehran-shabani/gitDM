# سناریو و پیشنهادها برای GitDM

## سناریوی کامل اپ (هدف و جریان کلی)
GitDM یک سامانهٔ مدیریت دیابت برای ثبت و نسخه‌بندی داده‌های بیماران است. کاربران (پزشکان و بیماران) با احراز هویت JWT وارد می‌شوند و پزشک می‌تواند برای بیماران خود پروفایل بسازد و اطلاعات بالینی را مدیریت کند:
- بیماران: ایجاد/ویرایش/حذف، مشاهده تایم‌لاین تجمیع‌شده.
- مواجهه‌های بالینی، نتایج آزمایش، و دستورات دارویی: ثبت و مدیریت رکوردها.
- خلاصه‌سازی هوش‌مصنوعی: تولید خلاصه از داده‌های بالینی با OpenAI/GapGPT (هم‌زمان یا ناهم‌زمان) و مشاهده آمار.
- نسخه‌بندی: نگهداری تاریخچهٔ تغییرات و قابلیت بازگردانی به نسخه‌های قبلی.
- خروجی گرفتن از دادهٔ بیمار: ارائه ساختار پایه برای انتقال/گزارش.

## سناریوی کوتاه برای ویژگی جدید (۲ خط)
- «داشبورد روند HbA1c»: نمایش نمودار روند HbA1c هر بیمار با آستانه‌های هشدار و پیشنهادات مبتنی بر گایدلاین.
- «وبهوک رویداد نسخه‌بندی»: با هر تغییر نسخه، یک وبهوک استاندارد به سامانهٔ بیرونی ارسال شود تا همگام‌سازی انجام گیرد.

## ارزیابی اجرای سرور نسبت به انتظار (آیا کار لازمه را انجام می‌دهد؟)
- احراز هویت و مسیرهای اصلی: مطابق README و OpenAPI، مسیرهای `/api/`، اسناد (`/api/docs`, `/api/redoc`, `/api/schema`)، سلامت (`/health`) و JWT (`/api/token`, `/api/token/refresh`) پیاده‌سازی و فعال هستند. تنظیمات DRF پیش‌فرض `IsAuthenticated` است و برای `gitdm.PatientViewSet` صراحتاً اعمال شده است؛ بقیهٔ ویوسِت‌ها نیز تحت تنظیمات سراسری محافظت می‌شوند.
- بیماران و تایم‌لاین: `PatientViewSet` با محدودسازی دسترسی بر اساس `primary_doctor` کاربر جاری پیاده‌سازی شده و اکشن `timeline` دادهٔ تجمیع‌شده را با حد بالا برمی‌گرداند. انتظار مستندات برآورده می‌شود.
- مواجهه/آزمایش/دارو: CRUD موجود است؛ در `Encounter` هنگام ایجاد، `created_by` از کاربر فعلی تنظیم می‌شود. سایر ویوسِت‌ها نیز طبق مدل‌ها کار می‌کنند.
- خلاصه‌های AI: ویوسِت `AISummary` ایجاد/فهرست/حذف، اکشن‌های `regenerate`، `test` و `stats` را دارد و با GapGPT/OpenAI سازگار است. پیام‌های وضعیت مناسب بازگردانده می‌شوند.
- نسخه‌بندی: سرویس‌ها و سیگنال‌ها برای `PatientProfile`، `Encounter`، `LabResult` و `MedicationOrder` فعال است؛ endpoint های فهرست نسخه و بازگردانی موجود است و مطابق انتظار عمل می‌کند.
- خروجی بیمار: اندپوینت `/api/export/patient/{id}/` وجود دارد و ساختار پایه را بازمی‌گرداند. (در حال حاضر فقط اسکلت داده را برمی‌گرداند.)

نتیجه: سرور به‌طور کلی مطابق انتظار مستندات عمل می‌کند و مسیرهای کلیدی فعال هستند. برخی موارد بهبود امنیت/مالکیت داده و غنای خروجی قابل پیشنهاد است.

## پیشنهادها (بهبود و/یا ویژگی جدید)
1) تقویت مالکیت داده و فیلترگذاری در ویوسِت‌ها
- پیشنهاد: همانند `PatientViewSet`، در `EncounterViewSet`، `LabResultViewSet` و `MedicationOrderViewSet` نیز `get_queryset` با محدودسازی بر اساس `primary_doctor` بیمار یا سازندهٔ رکورد اعمال شود تا دسترسی‌ها دقیق‌تر شود.
- دلیل: کاهش ریسک دسترسی ناخواسته و هم‌ترازی با مدل دسترسی بیمار-پزشک.

2) غنی‌سازی اندپوینت خروجی بیمار
- پیشنهاد: تکمیل فهرست‌های `encounters`، `labs`، `medications` و `ai_summaries` با دادهٔ واقعی (به‌همراه فیلتر مالکیت/دسترسی)، اضافه‌کردن گزینهٔ `?include=` برای کنترل بخش‌ها، و پشتیبانی از فرمت‌های `jsonl`/`csv`.
- دلیل: کاربرد بیشتر برای گزارش‌گیری، مهاجرت داده و تحلیل ثانویه.

3) افزودن وبهوک برای رویدادهای نسخه‌بندی
- پیشنهاد: پشتیبانی از ثبت مقصد وبهوک و ارسال payload استاندارد هنگام ایجاد نسخهٔ جدید یا بازگردانی؛ همراه با امضا (HMAC) و retry با backoff.
- دلیل: یکپارچگی با سامانه‌های بیرونی و همگام‌سازی دادهٔ زمان‌واقعی.

4) داشبورد روند HbA1c و شاخص‌ها
- پیشنهاد: افزودن endpoint آمار/روند آزمایش‌ها (خصوصاً HbA1c) برای هر بیمار به‌همراه آستانه‌ها و هشدارهای ساده، و نمودار در UI آینده یا خروجی JSON برای کلاینت‌ها.
- دلیل: ارزش بالینی مستقیم برای مدیریت دیابت و پایش کنترل گلیسمی.

5) بهبود پایداری خلاصه‌سازی AI
- پیشنهاد: ذخیرهٔ provider و پارامترهای تولید در متادیتا، لاگ ساخت‌یافته برای ردیابی خطا، و fallback خودکار بین GapGPT/OpenAI در صورت عدم دسترسی.
- دلیل: پایایی و قابلیت ردیابی در محیط‌های Production.

6) کنترل سرعت و سقف درخواست‌ها (Rate Limit)
- پیشنهاد: فعال‌سازی throttling DRF برای مسیرهای حساس مانند AI و export و افزودن نرخ‌های متفاوت برای نقش‌ها.
- دلیل: محافظت از سرویس و کنترل هزینهٔ سرویس‌های بیرونی.

7) سخت‌گیری امنیتی در Production
- پیشنهاد: اجباری‌کردن `DJANGO_SECRET_KEY` و تنظیم `ALLOWED_HOSTS`/`CSRF_TRUSTED_ORIGINS`، غیر‌فعال‌سازی DEBUG، و افزودن Security Headers (HSTS, CSP) در محیط عملیاتی.
- دلیل: کاهش سطح حمله و انطباق با بهترین‌روش‌ها.

8) آزمون‌های تکمیلی مجوزها و مالکیت
- پیشنهاد: افزودن تست‌های دسترسی متقاطع (کاربر A نتواند دادهٔ بیمار B را ببیند/ویرایش کند) برای همهٔ ویوسِت‌ها و endpoint های versions/export.
- دلیل: جلوگیری از regression در امنیت و انطباق با سیاست‌های دادهٔ سلامت.

9) اسناد OpenAPI هماهنگ با مسیرهای واقعی
- پیشنهاد: بازبینی `OpenAPI.yml` برای هم‌راستایی کامل با مسیرهای `gateway` (مانند health، token aliasها، export) و افزودن نمونه‌های درخواست/پاسخ برای اکشن‌های AI.
- دلیل: سهولت مصرف API و کاهش ابهام برای کلاینت‌ها.

10) قابلیت «ردیابی منبع تغییر» در نسخه‌بندی
- پیشنهاد: ثبت دقیق‌تر منبع تغییر (created_by/updated_by/primary_doctor) در `meta` هر نسخه و افزودن endpoint فیلتر براساس «عامل تغییر».
- دلیل: ممیزی بهتر و پاسخ‌گویی در تغییرات کلینیکی.